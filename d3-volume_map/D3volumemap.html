<!doctype html>
<meta charset="utf-8">
<html>
	<head>
		<script src="https://d3js.org/d3.v4.min.js"></script>
		<script src="https://d3js.org/d3-path.v1.min.js"></script>
		<script src="https://d3js.org/d3-scale.v1.min.js"></script>
	</head>
	<body>
		<h1>Hello World!</h1>
		<script>
		/* Load CSV Data
		***********************************************************************/
		var testarr = [{line: 1, x1: 100, y1: 100, x2: 100, y2: 200},{line: 2, x1: 100, y1: 100, x2: 200, y2: 100}];
		// CSV column types for streets_lines.csv
		var slConverter = function(d) {
			return {
				line: +d.line,
				streetname: d.streetname,
				directions: d.directions,
				x1: +d.x1,
				y1: +d.y1,
				x2: +d.x2,
				y2: +d.y2
			};
		};
		
		/*
		// Row conversion for streets_lines
		var streets_lines = [];
		d3.csv("streets_lines.csv", function(d) {
			streets_lines = d.map(slConverter);
			console.log(streets_lines);
		});
		*/
		
		
		// CSV column types for streets_segments.csv
		var ssConverter = function(d) {
			return {
				line: +d.segment,
				streetname: d.streetname,
				direction: d.direction,
				segdesc: d.segdesc,
				x1: +d.x1,
				y1: +d.y1,
				x2: +d.x2,
				y2: +d.y2
			};
		};
		
		/*
		// Row conversion for streets_segments
		var streets_segments = [];
		d3.csv("streets_segments.csv", function(d) {
			streets_segments = d.map(ssConverter);
			console.log(streets_segments);
		});
		*/
		
		
		/* Setup SVGs
		***********************************************************************/
		var svgW = 1200;
		var svgH = 500;
		var stroke = "black";
		var strokeWidth = 5;
		var pathfill = "none";
		
		
		// Create SVG container
		var svgContainer = d3.select("body").append("svg")
			.attr("width", svgW)
			.attr("height", svgH);
		
		
		
		// function to get attributes from all objects in an array
		function getArrObjAtt(arr, att) {
			var attr;
			var fieldname = att.toString()
			arr.forEach(function(obj) {
				attr = obj[fieldname];
				// console.log(attr);
				return attr;
				})
			return attr;
		}
		
		// function to get specified attribute from an object
		function getObjAtt(obj, att) {
			var attr;
			var fieldname = att.toString()
			attr = obj[fieldname];
			// console.log(attr);
			return attr;
		}
		
		
		
		/* Scale SVGs
		***********************************************************************/
		// Create arrays of streets_lines X and Y values
		var xArr = [];
		function xAccess(arr) {
			xArr = [];
			arr.forEach(function(obj) {
				xArr.push(obj.x1);
				xArr.push(obj.x2);
			});
			return xArr;
		}
		
		var yArr = [];
		function yAccess(arr) {
			yArr = [];
			arr.forEach(function(obj) {
				yArr.push(obj.y1);
				yArr.push(obj.y2);
			});
			return yArr;
		}
		
		
		var xMin, xMax, yMin, yMax, xScale, yScale;
		function scaling() {
			// Find x and y max/min of streets_lines
			xMin = d3.min(xArr)
			xMax = d3.max(xArr)
			yMin = d3.min(yArr)
			yMax = d3.max(yArr)
			
			// Create x and y Scales
			xScale = d3.scaleLinear()
				.domain([xMin, xMax])
				.range([100, svgW-100])
			yScale = d3.scaleLinear()
				.domain([yMin, yMax])
				.range([100, svgH-100])
		}
		
		
		/* Functions to draw SVGs
		***********************************************************************/
		// Create path generator
		function pathFunc(obj) {
			var path = d3.path();
			path.moveTo(xScale(obj.x1),yScale(obj.y1));
			path.lineTo(xScale(obj.x2),yScale(obj.y2));
			return path;
		}
		
		function drawPath(obj) {
			svgContainer.append("path")
				.attr("id", obj.line)
				.attr("d", pathFunc(obj))
				.attr("stroke", stroke)
				.attr("stroke_width", strokeWidth)
				.attr("fill", pathfill);
		}
		
		function pathGen(arr) {
				arr.forEach(drawPath);
		}
		
		
		
		/* Functions to label SVGs
		***********************************************************************/
		var fontfam = "san-serif";
		var fontsize = "12px";
		var fontfill = "red";
		
		var anchEW = "end";
		var anchNS = "start";
		var dxEW = -20;
		var dxNS = 20;
		var dyEW = ".35em"; // add half the text's height to its y attribute
		var dyNS = ".35em"; // add half the text's height to its y attribute
		
		
		// label a street object
		var text;
		function labelStreet(obj) {
			text = d3.select("svg")
				.append("text")
				.text(obj.streetname)
				.attr("x", xScale(obj.x1))
				.attr("y", yScale(obj.y1))
				.attr("font-family", fontfam)
				.attr("font_size", fontsize)
				.attr("fill", fontfill);
			// console.log(obj);
		}
		
		
		// label many street objects in an array
		function labelMany(arr) {
			arr.forEach(function(obj) {
				if (obj.streetname == "Front1") { // treating Front1 exactly like other EW streets
				obj.streetname = "Front"; // reassigning streetname
				labelStreet(obj);
				text.attr("text-anchor", anchEW)
					.attr("dx", dxEW)
					.attr("dy", dyEW);
				}
				else if (obj.streetname == "Front2") { // don't want to label Front2
				return;
				}
				else if (obj.directions == "NS") {
				var rotNS = "rotate(270 " + xScale(obj.x1) + "," + yScale(obj.y1) + ")"; // local rotate variable
				labelStreet(obj);
				text.attr("text-anchor", anchNS)
					.attr("transform", rotNS) // Coordinate system is also rotated, affecting dx and dy
					.attr("dx", dxNS)
					.attr("dy", dyNS);
				}
				else if (obj.directions == "EW" || obj.directions == "E" || obj.directions == "W") {
				labelStreet(obj);
				text.attr("text-anchor", anchEW)
					.attr("dx", dxEW)
					.attr("dy", dyEW);
				}
				else {
				labelStreet(obj);
				};
			});
		}
		
		
		
		/* Draw SVGs
		***********************************************************************/
		// Load data and execute functions requiring immediate access to data
		var streets_lines = [];
		var streets_segments = [];
		d3.csv("streets_lines.csv", function(sl) {
			streets_lines = sl.map(slConverter);
			d3.csv("streets_segments.csv", function(ss) {
				streets_segments = ss.map(ssConverter)
				// console.log(streets_lines);
				xAccess(streets_lines);
				yAccess(streets_lines);
				scaling()
				labelMany(streets_lines);
				pathGen(streets_lines);
				pathGen(streets_segments);
			});
		});
		
		
		

		

		
		
		</script>
	</body>
</html>
