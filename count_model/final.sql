WITH final AS (WITH rough AS (SELECT * FROM	(SELECT intersection_uid, dt, leg, dir  FROM(SELECT intersection_uid, datetime_bin::date AS dt	FROM miovision.volumes_15min WHERE datetime_bin::date < '2017-12-01' GROUP BY intersection_uid, datetime_bin::date	HAVING COUNT(DISTINCT datetime_bin) >= 90 ORDER BY intersection_uid, datetime_bin::date) intercombo	INNER JOIN (	SELECT intersection_uid, leg, dir, AVG(volume)	FROM 	miovision.volumes_15min	WHERE 	classification_uid in (1,4,5) GROUP BY intersection_uid, leg, dir HAVING AVG(volume) > 2 ORDER BY intersection_uid, leg) legdircombo USING (intersection_uid)) combos CROSS JOIN   (SELECT x::time AS t FROM generate_series('2000-01-01 0:00'::timestamp, '2000-01-01 23:45', '15 minutes'::interval) AS X) bins)	SELECT rough.intersection_uid, rough.dt as dt, rough.t as tm, rough.leg, rough.dir, vals.total_volume FROM rough LEFT JOIN (	SELECT intersection_uid, datetime_bin, leg, dir, SUM(volume) AS total_volume FROM miovision.volumes_15min WHERE classification_uid in (1,4,5) GROUP BY intersection_uid, datetime_bin, leg, dir) AS vals ON (rough.intersection_uid = vals.intersection_uid AND rough.dt = vals.datetime_bin::date AND rough.t = vals.datetime_bin::time AND rough.leg = vals.leg AND rough.dir = vals.dir)	ORDER BY intersection_uid, dt, leg, dir) SELECT intersection_uid, dt, leg, dir, cast(sum(new_volume) as int) totaladjusted_vol FROM (SELECT a.intersection_uid, a.dt, a.tm, a.leg, a.dir, a.total_volume,  coalesce(a.total_volume, AVG(B.total_volume)) as new_volume FROM final AS a	INNER JOIN final AS b USING (intersection_uid, leg, dir) WHERE EXTRACT(isodow FROM a.dt) < 6 and EXTRACT(isodow FROM a.dt) = EXTRACT(isodow FROM b.dt) AND a.tm = b.tm AND intersection_uid NOT IN (30) GROUP BY a.intersection_uid, a.dt, a.tm, a.leg, a.dir, a.total_volume) fin GROUP BY intersection_uid, dt, leg, dir ORDER BY intersection_uid, dt, leg, dir;




